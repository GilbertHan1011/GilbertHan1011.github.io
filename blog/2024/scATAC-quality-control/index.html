<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <hr> <p>layout: post title: All about scATAC-seq’s quality control date: 2024-04-21 21:01:00 description: I described a new way for scATAC-seq quality control tags: formatting images categories: sample-posts thumbnail: assets/img/9.jpg —</p> <p>One main challenge in scATAC-seq analysis is to distinguish the good cells (high quality cells), the bad cells(low quality cells), and the ugly cells (doublet cells).</p> <div class="row mt-3"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/GilbertHan1011.github.io/assets/img/2024-04-21-scATAC-quality-control/1713701483232.png" sizes="95vw"></source> <img src="/GilbertHan1011.github.io/assets/img/2024-04-21-scATAC-quality-control/1713701483232.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <div class="caption"> A simple, elegant caption looks good between image rows, after each row, or doesn't have to be there at all. </div> <p><img src="assets/img/2024-04-21-scATAC-quality-control/1713701483232.png" width="600"></p> <h2 id="the-bad--low-quality-cell">The bad—- low quality cell</h2> <h3 id="why-should-i-perform-quality-control">Why should I perform quality control</h3> <p>The low quality cells and the doublet cells can influence the downstream analysis, such as clustering (form a unique cluster), trajectory analysis (create artificial trajectories) and so on. <a href="https://bioconductor.org/books/3.18/OSCA.basic/quality-control.html#ref-lun2018overcoming" rel="external nofollow noopener" target="_blank">OSCA book</a> has great explaination about this issue.</p> <h3 id="what-metrics-are-used-to-distinguish-between-the-good-and-the-bad">What metrics are used to distinguish between the good and the bad</h3> <p>Different frameworks perfer different metrics to perform quality control. For example, <a href="https://www.archrproject.com/bookdown/per-cell-quality-control.html" rel="external nofollow noopener" target="_blank">ArchR</a> and <a href="https://kzhang.org/SnapATAC2/tutorials/pbmc.html" rel="external nofollow noopener" target="_blank">SnapATAC2</a> utilized TSS enrichment and number of unique fragments. And <a href="https://muon.readthedocs.io/en/latest/omics/atac.html#id1" rel="external nofollow noopener" target="_blank">Muon</a> use TSS enrichment and nucleosome signal to perform quality control. To compare what’s best strategy to preform quality control, I firstly classified the metrics to following categories.</p> <h4 id="sequencing-depth">Sequencing depth</h4> <p>Similar with scRNAseq datasets, scATAC has sequencing depth, which related with total number of fragments in peaks, unique fragment number, unique peak number, and so on. Low sequencing depth means low quailty. High sequencing depth may related with doublets, nuclei clumps, or other artefacts.</p> <h4 id="transcriptional-start-site-tss-enrichment-score">Transcriptional start site (TSS) enrichment score</h4> <p>TSS enrichment score is the ratio of fragments centered at the TSS to fragments in TSS-flanking regions. This metrics is used in nearly every scATAC framework. Extremely high TSS scores and extremely low TSS scores are both not good signs.</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713770714671.png" alt="1713770714671"></p> <h4 id="fraction-of-fragments-in-peaks-frip">Fraction of fragments in peaks (FRiP)</h4> <p>Represents the fraction of all fragments that fall within ATAC-seq peaks. This is a good metric to show signal-noise ratio.</p> <h4 id="nucleosome-banding-pattern">Nucleosome banding pattern</h4> <p>Because chromosomes are organized into units called nucleosomes, fragment size can exhibit periodic distribution correlated with nucleosome size. Fragments in high quality cells are nucleosome-free (&lt;147 bp).</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713771076735.png" width="900"></p> <h4 id="others">Others</h4> <p>For example, duplication fraction in <a href="https://pycistopic.readthedocs.io/en/latest/tutorials.html" rel="external nofollow noopener" target="_blank">pycistopic</a>, ratio reads in genomic blacklist regions in <a href="https://stuartlab.org/signac/articles/pbmc_vignette" rel="external nofollow noopener" target="_blank">signac</a>.</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713772397798.png" alt="1713772397798"></p> <h3 id="how-to-choose-quality-control-metrics">How to choose quality control metrics?</h3> <p>A good metric typically effectively distinguishes between good and bad cells. So, we begin by exploring whether the above metrics are indicative.</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713775198151.png" alt="1713775198151"></p> <p>We observed that the four metrics seperate bad cells (red box) and good cells well. If we combine these metrics, the seperation are more clear.</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713775982399.png" alt="1713775982399"></p> <h3 id="how-to-filter-cells-base-on-qc-metrics">How to filter cells base on QC metrics</h3> <p>While low quailty cells can be discovered with different reasons (i.e. low sequencing depth, high nucleosome signal), we noticed that high quality cells are usually clustered together. This give us a intuation, that we can select cells base on unspervise clustering methods, like Kmeans.</p> <p>Base on this thought, I apply kmeans on QC metrics to assess wether it can select high quality cells.</p> <p>I select TSS enrichment, nucleosome signal, percent of reads in peaks, number of fragment to be the feature. After normalization, I apply Kmeans.</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713785029703.png" alt="1713785029703"></p> <p>As we can see, Kmeans method is excellent at select high quality cells. Low quality cells are grouped together to form low-sequencing-depth cluster, high-nuleosome-signal cluster, and low-TSS score clusters.</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713784536547.png" alt="1713784536547"></p> <p>I tried different number of clusters in Kmeans. As we can see, this methods is very robust, high quality cells are always cluster togehter until cluster number increase to 6.</p> <h3 id="what-about-other-qc-methods">What about other QC methods</h3> <p>I compared different QC methods provided by various framework. The results are show below.</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713786089347.png" width="900"></p> <p>Not suprising, the results in different methods are similar. But what’s the best quality control methods? I used total cell number - unique cell number to roughly estimate the performance of different methods.</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713787023636.png" alt="1713787023636"></p> <p>As we can see, Kmeans methods has best performance in our datasets.</p> <h3 id="whats-filter-methods-of-cellrangers">What’s filter methods of cellrangers?</h3> <p>You may notice that cellranger’s quality control is very strict. While other methods leaves 18000-20000 cells, cellranger’s qc only leaves 11577 cells. You can find the filter results in <code class="language-plaintext highlighter-rouge">filtered_peak_bc_matrix.h5</code> and <code class="language-plaintext highlighter-rouge">singlecell.csv</code>. From their <a href="https://support.10xgenomics.com/single-cell-atac/software/pipelines/2.0/map/cr-atac" rel="external nofollow noopener" target="_blank">pipeline</a>, we can see it remove doublet and low quality cells with it’s own methods.</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713789253939.png" alt="1713789253939"></p> <p>It use <a href="https://kb.10xgenomics.com/hc/en-us/articles/360001892491-What-is-the-difference-between-the-filtered-and-raw-gene-barcode-matrix" rel="external nofollow noopener" target="_blank">cell-calling heuristic</a> to filter low sequencing depth cells. Due to its overly stringent filtering outcomes, I don’t believe that using cellranger’s filtering results from the outset is a good idea.</p> <h3 id="should-i-use-strict-qc-threshold-or-loose-qc-threshold">Should I use strict QC threshold or loose QC threshold?</h3> <p>I suggest to use loose method at first. The worst outcome with a loose QC threshold is an arificial cluster/trajectory. Usually you can find them at downstream. However, if you begin with strict QC at first, you may never know what opportunities you’ve missed in terms of discoveries.</p> <h2 id="the-ugly--doublets">The ugly —– doublets</h2> <h3 id="common-strategy-to-find-doublets">Common strategy to find doublets</h3> <p>There are two strategies to detect doublets. One approch is based on simulation, the other is based on coverage. <a href="https://www.sc-best-practices.org/chromatin_accessibility/quality_control.html#doublet-detection" rel="external nofollow noopener" target="_blank">Here</a> describe the difference between the two methods.</p> <h3 id="whats-the-best-way-to-detect-doublets">What’s the best way to detect doublets</h3> <p>As suggested by author of scDblFinder, it’s better to combine the two methods (coverage-based and simulation-based) to discover doublets. As most frameworks’ doublets detection methods are simulation-based, I compared the results run by scDblFinder, ArchR (<a href="https://github.com/statgen/demuxlet" rel="external nofollow noopener" target="_blank">demuxlet</a>), and SnapATAC2 (scrublet). The more related with amulet (coverage-based method), the results are better.</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713792040000.png" alt="1713792040000"></p> <p>As we can see, except ArchR showed bad performance, SnapATAC2 and scDblFinder both exhibit good performance.</p> <p><img src="image/2024-04-21-scATAC-quality-control/1713792200267.png" width="500"></p> <p>Actually, results of SnapATAC2(scrublet) and scDblFinder are similar. If you perfer strict quality control, you can use scDblFinder; else, you can use SnapATAC2.</p> <h2 id="take-home-message">Take home message</h2> <ul> <li>Kmeans are good strategy to filter low quality cells.</li> <li>Better not use cellranger filtered methods.</li> <li>Do not use ArchR to detect doublets.</li> <li>Combine Amulet and scDblFinder/SnapATAC2 to detect doublets.</li> </ul> </body></html>